#!/usr/bin/env bash
set -e

echo "--- Wyoming ONNX ASR Environment Setup ---"

# 1. System Dependencies
DISTRO=$(. /etc/os-release; echo "$ID")
VERSION_ID=$(. /etc/os-release; echo "$VERSION_ID" | tr -d '.')
ARCH="x86_64"

echo "ðŸ“¦ Installing system dependencies..."
sudo apt update && sudo apt install -y libsndfile1 python3-venv wget gnupg2

# 2. GPU Repository Setup
if nvidia-smi &> /dev/null; then
    echo "ðŸš€ NVIDIA GPU Detected. Setting up CUDA 12.6 repositories..."
    case "$DISTRO" in
        debian) REPO_NAME="debian${VERSION_ID}" ;;
        ubuntu) REPO_NAME="ubuntu${VERSION_ID}" ;;
        *) echo "âŒ Unsupported Distro: $DISTRO"; exit 1 ;;
    esac

    wget -q "https://developer.download.nvidia.com/compute/cuda/repos/${REPO_NAME}/${ARCH}/cuda-keyring_1.1-1_all.deb" -O cuda-keyring.deb
    sudo dpkg -i cuda-keyring.deb
    rm cuda-keyring.deb
    
    sudo apt update
    sudo apt-get -y install cuda-toolkit-12-6 cudnn9-cuda-12
    GPU_INSTALL=true
else
    echo "ðŸŒ No NVIDIA GPU detected. Proceeding with CPU-only environment."
    GPU_INSTALL=false
fi

# 3. Virtual Environment Setup
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
VENV_DIR="$PROJECT_ROOT/.venv"

echo "ðŸ Creating virtual environment at $VENV_DIR..."
python3 -m venv "$VENV_DIR"
source "$VENV_DIR/bin/activate"
pip install --upgrade pip wheel

# 4. Install via specific requirements files
if [ "$GPU_INSTALL" = true ]; then
    echo "âš™ï¸ Installing dependencies from requirements-gpu.txt..."
    pip install -r "$PROJECT_ROOT/requirements-gpu.txt"
else
    echo "âš™ï¸ Installing dependencies from requirements-cpu.txt..."
    pip install -r "$PROJECT_ROOT/requirements-cpu.txt"
fi

chmod +x "$SCRIPT_DIR/run" 2>/dev/null || true
chmod +x "$SCRIPT_DIR/install-service" 2>/dev/null || true

# 5. Finalize
echo "âœ… Setup complete! Run with ./script/run"